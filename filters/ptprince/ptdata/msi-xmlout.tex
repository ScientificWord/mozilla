\makeatletter
\def\msi@rfi#1#2{\def#1{\msitag{<requestimplementation>#2</requestimplementation>}}}


% This writes the css file my.css. 
% Do this at the end because it happens that we don't know what css are required. 
 
\def\msimakecss{
   \def\css{2}	  % the css output file
   \openout\css={css/my.css} %% the CSS style file for this document
   \write\css{@import url("resource://app/res/css/baselatex.css");}
   \write\css{@import url("resource://app/res/css/latex.css");}
   \write\css{\classcss}
   \closeout\css
}

\def\classcss{}

\msi@dollar=`\$

\def\msi@pass#1{\def#1{\msitag{<texb>#1</texb>}}}
\def\msi@pass@newline#1{\def#1{\br\msihmode\msitag{<texb>#1</texb>}}}
\def\msitexb#1{\msitag{<texb>#1</texb>}}


\msi@pass@newline{\@settodim}
\msi@pass@newline{\settoheight}
\msi@pass@newline{\settodepth}
\msi@pass@newline{\settowidth}


\def\MSIMathQuote#1{%
   %\expandafter\def\csname#1\endcsname{\char`\\#1\char32\relax}}
   \expandafter\def\csname#1\endcsname{\expandafter\string\csname#1\endcsname\char32\relax}}

%\MSIMathQuote{\\} %% may need to hard-code this one

\let\@dblslash\\
\def\\{\ifmmode\string\\\else\@dblslash\fi}



% \newcounter{#1}[#2]

\newtoks\preambleToks

\def\out@newcounterA#1{%
  \br\msitag{<texb>\newcounter{#1}</texb>}%   
}

\def\out@newcounterB#1[#2]{%                                                              
  \br\msitag{<texb>\newcounter{#1}[#2]</texb>}%
}


%% redefine these to produce output
\def\setcounter#1#2{%
    \expandafter\global\csname c@#1\endcsname#2\relax
    \br\msitag{<texb>\string\setcounter{#1}{#2}</texb>}}

\def\addtocounter#1#2{%
    \expandafter\global\advance\csname c@#1\endcsname #2\relax
    \out@addtocounter{#1}{#2}}


\msi@inline@proc={jbm}
\msi@display@proc{jbm}
\msi@everyrowstart{<tr>}
\msi@everyrowend{</tr>}
\msi@everycellstart{<td>}
\msi@everycellend{</td>}

\def\msi@stylesheets{\msitag{<?xml-stylesheet href="css/my.css" type="text/css"?>}\br}


\def\@brace#1{\char123\relax#1\char125\relax}

\def\br{\char10}


%% \documentclass.  
  
\def\out@documentclassA[#1]#2{%
   \msi@opendocument
   \br\msitag{<documentclass class="#2" options="#1"/>}%
}

\def\out@documentclassB#1{%
   \msi@opendocument
   \br\msitag{<documentclass class="#1"/>}%
}



\def\out@preamble@tex#1{
   \msitag{<preambleTeX>#1</preambleTeX>}%
}

%% \document and \enddocument

\def\out@begin@document{%
   \expandafter\out@preamble@tex\expandafter{\the\preambleToks}
   \msiclosetag{preamble}{</preamble>}%
   \br\msitag{</head>}
   \br\msiopentag{body}{<body>}
   %%\msihmode\br\msiopentag{docbody}{<docbody>}%
   \@paragraphs
   \msivmode
}

\def\out@end@document{%
   %%\br\msiclosetag{docbody}{</docbody>}%
   \br\msiclosetag{body}{</body>}
   \br\msitag{</html>}%
   \msimakecss
   \endinput
}


%% \usepackage
\def\out@usepackageA[#1]#2{%
   \br\msitag{<usepackage package="#2" options="#1"/>}%
}
\def\out@usepackageB#1{%
   \br\msitag{<usepackage package="#1"/>}%
}


%% Frontmatter

\def\title#1{\gdef\@title{#1}\out@title{#1}}
\def\author#1{\gdef\@author{#1}\out@author{#1}}
\def\date#1{\gdef\@date{#1}\out@date{#1}}

\def\thanks#1{\out@thanks{#1}}
\def\and{\out@and}


%\def\frontmatter{\out@frontmatter}
%\def\mainmatter{\out@mainmatter}





\def\out@title#1{%
   {\everypar={}\msitag{^^0a}\msiopentag{title}{<title>}#1\msiclosetag{title}{</title>}}}

\def\out@thanks#1{%
   \msitag{^^0a}\msiopentag{thanks}{<thanks>}#1\msiclosetag{thanks}{</thanks>}}

   
\def\out@author#1{%
  \begingroup
   \def\\{\msitag{^^0a}\msiopentag{address}{<address>}\ignorespaces}%
   \def\and{\msiclosetag{author}{</author>}\msitag{^^0a}\msiopentag{author}{<author>}}%
   \msitag{^^0a}\msiopentag{author}{<author>}#1\msiclosetag{author}{</author>}%
  \endgroup
}

\def\out@date#1{%
   \msihmode\br\msiopentag{date}{<date>}#1\msiclosetag{date}{</date>}}



\def\MSIEmptyElement{%
  \@ifnextchar[{\msi@empty@elmA}{\msi@empty@elmB}}

\def\msi@empty@elmA[#1]#2{%
  \expandafter\def\csname #2\endcsname{\msihmode\br\msitag{<#1/>}}}

\def\msi@empty@elmB#1{\msi@empty@elmA[#1]{#1}}
   

\def\MSISimpleEnvironment{%
  \@ifnextchar[{\msi@simple@envA}{\msi@simple@envB}}

\def\msi@simple@envA[#1]#2{%
  \expandafter\def\csname msi@begin@#2\endcsname{\msi@open@element<#1>}
  \expandafter\def\csname msi@end@#2\endcsname{\msi@close@element</#1>}}

\def\msi@simple@envB#1{\msi@simple@envA[#1]{#1}}



%% newtheorem

\def\out@newtheorema#1[#2]#3{%
   \expandafter\preambleToks\expandafter{\the\preambleToks^^0a\newtheorem{#1}[#2]{#3}}
   \@namedef{msi@begin@#1}{\br\msiopentag{theorem}{<theorem type="#1">}}
   \@namedef{msi@end@#1}{\br\msiclosetag{theorem}{</theorem>}}
}

\def\out@newtheoremb#1#2{%
   \expandafter\preambleToks\expandafter{\the\preambleToks^^0a\newtheorem{#1}{#2}}
   \@namedef{msi@begin@#1}{\br\msiopentag{theorem}{<theorem type="#1">}}
   \@namedef{msi@end@#1}{\br\msiclosetag{theorem}{</theorem>}}
}



% Two forms of the \newenvironment command



\def\@declarenewenva#1[#2][#3]#4#5{%
   \br\msitag{<newenvironment name="#1" nargs="#2" opt="#3" start="#4" end="#5" />}
}
\def\@declarenewenvb#1#2#3{%
   \br\msitag{<newenvironment name="#1" start="#4" end="#5" />}
}



%% Citations and cross refs


\def\out@citex[#1]#2{\msiopentag{cite}{<cite>}#2\msiclosetag{cite}{</cite>}}
\def\out@citey#1{\msiopentag{cite}{<cite>}#1\msiclosetag{cite}{</cite>}}



%\def\ref#1{\msiopentag{ref}{<a>}#1\msiclosetag{ref}{</a>}}
%\def\pageref#1{\msiopentag{pageref}{<pageref>}#1\msiclosetag{pageref}{</pageref>}}

\def\pagenumbering#1{%
   \msiopentag{latexstyleb}{<latexstyleb>}%
      \msiopentag{styleprop}{<styleprop>}%
         page number style
      \msiclosetag{styleprop}{</styleprop>}%
      \msiopentag{styledata}{<styledata>}%
         #1
      \msiclosetag{styledata}{</styledata>}%
   \msiclosetag{latexstyleb}{</latexstyleb>}}


\def\msi@pass#1{\def#1{\msitag{#1}}}


\newif\if@first@item


\def\out@itema[#1]{
   \if@first@item
     \@first@itemfalse
   \else     
     \def\enditemtag##1{\msiclosetag{##1}{</##1>}}%
     \expandafter\enditemtag\expandafter{\itemprefix item}%
   \fi
   \def\startitemtag##1{\br\msihmode\msiopentag{##1}{<##1>}}%
   \expandafter\startitemtag\expandafter{\itemprefix item}%
   \msitag{<explicit-item>}#1\msitag{</explicit-item>}%
}

\def\out@itemb{
   \if@first@item
     \@first@itemfalse
   \else
     \def\enditemtag##1{\msiclosetag{##1}{</##1>}}%
     \expandafter\enditemtag\expandafter{\itemprefix item}%
   \fi
   \def\startitemtag##1{\br\msihmode\msiopentag{##1}{<##1>}\msiopentag{para}{<para>}}%
   \expandafter\startitemtag\expandafter{\itemprefix item}%
}




\def\out@bibitemA[#1]#2{%
   \if@first@item
     \@first@itemfalse
   \else
     \msiclosetag{item}{</bibitem>}%
   \fi
   \br\msihmode\msiopentag{bibitem}{}<bibitem label="#1" ref="#2">%
   \msitag{<explicit-item>}#1\msitag{</explicit-item>}%
}

\def\out@bibitemB#1{%
   \if@first@item
     \@first@itemfalse
   \else
     \msiclosetag{bibitem}{</bibitem>}%
   \fi
   \msitag{^^0a}\msiopentag{bibitem}{<bibitem ref="#1">}%
}


\def\@closeitem{\msiclosetag{li}{</li>}}
\def\@openitem{\msiopentag{li}{<li>}}


\def\MSIListEnvironment{%
  \@ifnextchar[{\msi@listenv@a}{\msi@listenv@b}}

\def\msi@listenv@b#1{%
  \expandafter\def\csname msi@begin@#1\endcsname{%
      \def\itemprefix{}%
      \everypar={}\msihmode\msitag{^^0a^^0a}\@first@itemtrue\msiopentag{#1}{<#1>}}

  \expandafter\def\csname msi@end@#1\endcsname{%
      \br\msiclosetag{#1}{</#1>}}}

\def\msi@listenv@a[#1]#2{%
  \expandafter\def\csname msi@begin@#2\endcsname{%
      \def\itemprefix{#1}%
      \everypar={}\msihmode\msitag{^^0a^^0a}\@first@itemtrue\msiopentag{#1}{<#1>}}

  \expandafter\def\csname msi@end@#2\endcsname{%
      \br\msiclosetag{#1}{</#1>}}}

       
\def\msi@begin@thebibliography#1{%
  \everypar={}\msihmode\msitag{^^0a^^0a}\@first@itemtrue \msiopentag{thebibliography}{<thebibliography>}%
}

\def\msi@end@thebibliography{\br\msiclosetag{description}{</description>}}


\def\msi@thm@like#1{}





%\input msiframe.tex


\def\msi@begin@equation{$$}
\def\msi@end@endequation{$$}

%% jcs \def\[#1\]{%
%% jcs   \ %
%% jcs   %%\temptoksa={\[#1\]}%
%% jcs   %%\msiextproc{jbm}{\the\temptoksa}%
%% jcs   \msiextproc{jbm}{\[#1\]}%
%% jcs }



\newcount\seclevel
\seclevel=0

\newif\if@starred
\def\@gobble#1{}

\def\newsection#1#2#3#4{%
  \expandafter\newcount\csname#1number\endcsname
  \csname#1number\endcsname=0
  \expandafter\def\csname the#1\endcsname{#3}%
  \expandafter\def\csname #1\endcsname{%
     \@ifnextchar*{\@starredtrue\csname @#1\endcsname}%
                  {\@starredfalse\csname @#1\endcsname *}%
  }
  \expandafter\def\csname @#1\endcsname*{%
     \@ifnextchar[{\csname @@#1\endcsname}%
                  {\csname @@#1\endcsname[]}%
  }
  \expandafter\def\csname @@#1\endcsname[##1]##2{%
     \seclevel=#2%
     \expandafter\advance\csname #1number\endcsname by 1%
     \let\protect\relax
     \msiclosetag{#1}{</#1>}%
     \msitag{^^0a}\msiopentag{#1}{<#1>}%
     {\everypar={}\msitag{^^0a}\msiopentag{#4}{<#4>}##2\msiclosetag{#4}{</#4>}}
  }%
}


\newsection{part}{1}{Part \the\partnumber}{sectiontitle}%
\newsection{chapter}{1}{Chapter \the\chapternumber}{sectiontitle}%

\def\out@marginparA#1#2{%
  \@start@notewrapper
  \msiopentag{note}{<note type="marginpar" opt="#1">}#2\msiclosetag{note}{</note>}%
  \@end@notewrapper
}

\def\out@marginparB#1{%
  \@start@notewrapper
  \msiopentag{note}{<note type="marginpar">}#1\msiclosetag{note}{</note>}%
  \@end@notewrapper
}

\def\rule{%
  \@ifnextchar[{\@rule}{\@rule[0pt]}%
}
\def\@rule[#1]#2#3{%
   \ifmmode
      \string\rule[#1]\char123#2\char125\char123#3\char125
   \else
      \msitag{<rule width="#2" height="#3" depth="#1"/>}%
   \fi
}


\def\hspace{%
   \@ifnextchar*{\@hspacestar}{\@hspace}}

\def\@hspace#1{   
   \ifmmode
     \string\hspace\@brace{#1}%
   \else
     \msitag{<hspace dim="#1" type="customSpace"></hspace>}%
   \fi
}

\def\@hspacestar#1#2{
   \@hspace{#2}%
}

\def\@paragraphs{%
  \let\@par\par
  \def\par{\msiclosetag{para}{</para>}\@par}%
  \everypar{\msihmode\br\msiopentag{para}{<para>}}%
}


\everymath{%
   \aftergroup\endmath
}
\def\endmath{}

\everydisplay{%
  \aftergroup\enddisplay
}
\def\enddisplay{}


\def\@make@braces@other{%
  \catcode`\{=12%
  \catcode`\}=12%
  \relax
}
\def\@make@braces@normal{%
  \catcode`\{=1%
  \catcode`\}=2%
  \relax
}

\bgroup
  \catcode`\^^M=13\relax
  \gdef^^M{\char13\char10\relax}%
\egroup


%  \def\@make@linebreak@other{%
%    \catcode`\^^M=13\relax
%  }
%  
%  \def\@make@linebreak@normal{%
%    \catcode`\^^M=5\relax
%  }

\newtoks\temptoksa

\bgroup
  \@make@braces@other
  \catcode`\[=1
  \catcode`\]=2
  \gdef\@scan@eqnarray@star#1\end{eqnarray*}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{eqnarray*}#1\end{eqnarray*}]%
     \msiclosetag[mml][</mml:math>]
  ]
  \gdef\@scan@eqnarray#1\end{eqnarray}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{eqnarray}#1\end{eqnarray}]%
     \msiclosetag[mml][</mml:math>]
  ]

  \gdef\@scan@multline@star#1\end{multline*}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{multline*}#1\end{multline*}]%
     \msiclosetag[mml][</mml:math>]
  ]

  \gdef\@scan@align@star#1\end{align*}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{align*}#1\end{align*}]%
     \msiclosetag[mml][</mml:math>]
  ]  
  \gdef\@scan@align#1\end{align}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{align}#1\end{align}]%
     \msiclosetag[mml][</mml:math>]
  ]
  \gdef\@scan@gather@star#1\end{gather*}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{gather*}#1\end{gather*}]%
     \msiclosetag[mml][</mml:math>]
  ]  


  \gdef\@scan@equation@star#1\end{equation*}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{equation*}#1\end{equation*}]%
     \msiclosetag[mml][</mml:math>]
  ]
  \gdef\msi@mtabular#1#2\end{tabular}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{tabular}{#1}#2\end{tabular}]
  ]
  \gdef\@scan@array#1\end{array}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{array}#1\end{array}]
  ]
  \def\endarray[\cr\egroup\string\end`\{array\char`\}]
  \gdef\@scan@bmatrix#1\end{bmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{bmatrix}#1\end{bmatrix}]
     %\temptoksa=[\begin{bmatrix}#1\end{bmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@Bmatrix#1\end{Bmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{Bmatrix}#1\end{Bmatrix}]
     %\temptoksa=[\begin{Bmatrix}#1\end{Bmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@smallmatrix#1\end{smallmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{smallmatrix}#1\end{smallmatrix}]
  ]

  \gdef\@scan@vmatrix#1\end{vmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{vmatrix}#1\end{vmatrix}]
     %\temptoksa=[\begin{vmatrix}#1\end{vmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@Vmatrix#1\end{Vmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{Vmatrix}#1\end{Vmatrix}]
     %\temptoksa=[\begin{Vmatrix}#1\end{Vmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@pmatrix#1\end{pmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{pmatrix}#1\end{pmatrix}]
     %\temptoksa=[\begin{pmatrix}#1\end{pmatrix}]%
     %\the\temptoksa
  ]
\egroup

\@namedef{msi@begin@eqnarray*}{\ \@make@braces@other\relax\@scan@eqnarray@star}
\@namedef{msi@begin@eqnarray}{\ \@make@braces@other\relax\@scan@eqnarray}

\@namedef{msi@begin@multline*}{\ \@make@braces@other\relax\@scan@multline@star}


\@namedef{msi@begin@align*}{\ \@make@braces@other\relax\@scan@align@star}
\@namedef{msi@begin@align}{\ \@make@braces@other\relax\@scan@align}
\@namedef{msi@begin@gather*}{\ \@make@braces@other\relax\@scan@gather@star}

\@namedef{msi@begin@equation*}{\ \@make@braces@other\relax\@scan@equation@star}
\def\msi@begin@array{\ \@make@braces@other\relax\@scan@array}

\def\msi@begin@bmatrix{\@make@braces@other\relax\@scan@bmatrix} 
\def\msi@begin@Bmatrix{\@make@braces@other\relax\@scan@Bmatrix} 
\def\msi@begin@smallmatrix{\@make@braces@other\relax\@scan@smallmatrix} 
\def\msi@begin@vmatrix{\@make@braces@other\relax\@scan@vmatrix} 
\def\msi@begin@Vmatrix{\@make@braces@other\relax\@scan@Vmatrix} 
\def\msi@begin@pmatrix{\@make@braces@other\relax\@scan@pmatrix}



{\catcode`\^^M=\active % these lines must end with %
  \gdef\obeylines{\catcode`\^^M\active \let^^M\par}%
  \global\let^^M\par} % this is in case ^^M appears in a \write
\def\obeyspaces{\catcode`\ \active}
\def\space{ }
{\obeyspaces\global\let =\space}

 



\def\@cr{\@ifnextchar[{\@cra}{\@crb}}
\def\@cra[#1]{\cr}%
\def\@crb{\cr}%
\def\msi@begin@tabular{%
   \@ifnextchar[{\msi@begin@tabularA}{\msi@begin@tabularA[]}%
}


\def\msi@begin@tabularA[#1]#2{%
   \ifmmode
      \def\donext{\@make@braces@other\relax\msi@mtabular{#2}}%
   \else
      \def\donext{%
         \begingroup
            \msiopentag{tabular}{<tabular opt="#2">}%
            \aftergroup\msi@closetabular
            \hbox\bgroup
              \let\\=\@cr
              \halign\bgroup&####\cr
      }%
   \fi
   \donext
}

\def\msi@closetabular{\msiclosetag{tabular}{</tabular>}}

\def\msi@end@tabular{\crcr
     \egroup %halign
   \egroup   %hbox
 \endgroup   %donext
}

\def\cline#1{}
\def\hline{}
\def\multicolumn#1#2#3{%
   \count0=#1\relax
   \ifnum\count0=1
      #3
   \else
      \msitag{ Unimplemented multicol }
   \fi
}

\def\endbrace{\char`\}}
\chardef\other=12
\chardef\active=13
\bgroup
   \catcode`&=\active
   \gdef&{\char`&amp;}%
\egroup


\def\out@verbatim#1{%
  \br\msitag{<pre>}#1\msitag{</pre>}}

\def\verb{%
   \bgroup
      \catcode`\\=\other
      \catcode`{=\other
      \catcode`}=\other
      \catcode`&=\active
      \catcode`$=\other
      \catcode`##=\other
      \msiopentag{verb}{<verb>}%
      \@sverb   
}
\def\verb@egroup{\msiclosetag{verb}{</verb>}\egroup}
\def\@sverb#1{%
  \catcode`#1\active
  \lccode`\~`#1\relax
  \lowercase{\let~\verb@egroup}%
}

\def\fbox#1{\ifmmode\temptoksa={#1}\string\fbox\char`\{\the\temptoksa\char`\}\fi}
\def\{{\ifmmode\string\{\else\char123\relax\fi}
\def\}{\ifmmode\string\}\else\char125\relax\fi}
\let\@hbox\hbox
\def\hbox{%
   \def\@after{}
   \ifmmode
      \string\hbox\char`\{\aftergroup\endbrace
   \else
      \def\@after{\@hbox}%
   \fi
   \@after
}


\def\mathbf#1{\string\mathbf\char123#1\char125}
\def\mathfrak#1{\string\mathfrak\char123#1\char125}

\def\LaTeX{<latex>LaTeX</latex>}
\def\TeX{<tex>TeX</tex>}



% Operators


\def\TEXTsymbol#1{%
  \ifmmode
    \temptoksa={\TEXTsymbol{#1}}%
    \the\temptoksa
  \else
    #1%
  \fi
}

%\def\backslash{\@hex{5c}}

%\def\textendash{\@hex{e28093}}
%\def\textemdash{\@hex{e28094}}
\msi@pass{\backslash}

\def\textemdash{\@hex{2014}}



{\catcode`\$=11\relax
 \gdef\${\char`\$}
}




\def\@hex#1{\char38\char35x#1;}


\newif\if@inaccent
\@inaccentfalse


\def\@accent#1#2{%
    \if@inaccent
      \@@accent{#1}{#2}%
    \else
      \@inaccenttrue
      \expandafter\csname \@@accent{#1}{#2}\endcsname
      \@inaccentfalse
    \fi
}

\def\@@accent#1#2{%
    \ifx#1\i
      dotlessi-#2
    \else\ifx#1\j
      dotlessj-#2
    \else 
      #1-#2
  \fi\fi\fi
}

\def\`#1{\@accent{#1}{grave}}

\def\'#1{\@accent{#1}{acute}}

\def\~#1{\@accent{#1}{tilde}}

\def\^#1{\@accent{#1}{caret}}

\def\=#1{\@accent{#1}{bar}}

\def\"#1{\@accent{#1}{umlat}}

\def\c#1{\@accent{#1}{ced}}

\def\.#1{\@accent{#1}{dot}}

\def\r#1{\@accent{#1}{r}}

\def\H#1{\@accent{#1}{H}}

\def\v#1{\@accent{#1}{v}}

\def\u#1{\@accent{#1}{u}}

\def\k#1{\@accent{#1}{k}}



%% \'{\^{e}}

\def\MSIUnicode#1#2{\@namedef{#1}{\@hex{#2}}}


%% Spacing


\def\qquad{%
   \ifmmode
      \msitag{\qquad}%
   \else
      \msihmode\msitag{<hspace dim="2em" type="twoEmSpace">}\@hex{2001}\msitag{</hspace>}%
   \fi
}

\def\quad{%
   \ifmmode
     \msitag{\quad}%
   \else
     \msihmode\msitag{<hspace dim="1em" type="emSpace">}\@hex{2003}\msitag{</hspace>}%
   \fi
}

\def\ {\msihmode{ }}

\def~{%
  \ifmmode
  \else
    \msihmode\msitag{<hspace type="nonBreakingSpace">}\@hex{a0}\msitag{</hspace>}%
  \fi}

\def\/{\msihmode\msitag{<hspace dim="0.083en" type="italicCorrectionSpace">}\@hex{200a}\msitag{</hspace>}}

\bgroup
  \catcode`\%=12
  \gdef\strut{\msitag{<vspace lineHt="100%" type="strut"/>}}
\egroup


\def\noindent{\par\msitag{<hspace dim="0.0em" type="noIndent"></hspace><requestimplementation>noindent</requestimplementation>}}


\def\thinspace{%
   \ifmmode
      \string\thinspace
   \else
      \msihmode\msitag{<hspace dim="0.17em" type="thinSpace">}\@hex{2009}\msitag{</hspace>}%
   \fi
}

\def\thickspace{%
   \ifmmode
      \string\thickspace
   \else
      \msihmode\msitag{<hspace dim="0.5em" type="thickSpace">}\@hex{2002}\msitag{</hspace>}%
   \fi
}


\def\negthinspace{%
   \ifmmode
      \string\negthinspace
   \else
      \msihmode\msitag{<hspace dim="0.0em" type="negativeThinSpace"></hspace>}%
   \fi
}







\def\out@hrulefill{%
   <hspace fillWith="line" flex="1" class="stretchySpace" type="stretchySpace"></hspace>}


\msi@rfi{\newpage}{\newpage}
\msi@rfi{\msi@hook@hfil}{\hfil}
\msi@rfi{\msi@hook@hfill}{\hfill}

\msi@rfi{\msi@hook@vfil}{\vfil}
\msi@rfi{\msi@hook@vfill}{\vfill}

%%\def\msi@hook@hss{\msitag{\hss}}
%%\def\msi@hook@vss{\msitag{\vss}}






\def\label#1{%
   \ifmmode
      \string\label\@brace{#1}%
   \else
      \msihmode\msitag{<marker id="#1"/>}%
   \fi
}

\def\frac#1#2{\string\frac\@brace{#1}\@brace{#2}}
\def\dfrac#1#2{\string\dfrac\@brace{#1}\@brace{#2}}

\def\unit#1{\string\unit\@brace{#1}}

\def\mathbf#1{\string\mathbf\@brace{#1}}
\def\mathit#1{\string\mathit\@brace{#1}}
\def\mathsf#1{\string\mathsf\@brace{#1}}
\def\mathtt#1{\string\mathtt\@brace{#1}}
\def\mathrm#1{\string\mathrm\@brace{#1}}




\def\func#1{\string\func\@brace{#1}}
\def\limfunc#1{\string\limfunc\@brace{#1}}


\def\sqrt{%
  \@ifnextchar[%
    {\@nthroot}%
    {\@sqrt}}

\def\@sqrt#1{%
   \string\sqrt\@brace{#1}%
}

\def\@nthroot[#1]#2{%
   \string\sqrt[#1]\@brace{#2}%
}


%\msi@mathmlpass{\thinspace}



\def\mathpass@arg#1{%
  \def#1##1{\string#1\@brace{##1}}
}

\def\mathpass@arg@arg#1{%
  \def#1##1##2{\string#1\@brace{##1}\@brace{##2}}
}
\def\mathpass@arg@arg@arg#1{%
  \def#1##1##2##3{\string#1\@brace{##1}\@brace{##2}\@brace{##3}}
}
\def\mathpass@arg@arg@arg@arg#1{%
  \def#1##1##2##3##4{\string#1\@brace{##1}\@brace{##2}\@brace{##3}\@brace{##4}}
}

\def\mathpass@arg@arg@arg@arg@arg#1{%
  \def#1##1##2##3##4##5{\string#1\@brace{##1}\@brace{##2}\@brace{##3}\@brace{##4}\@brace{##5}}
}



\mathpass@arg{\tag}


\mathpass@arg{\mathbb}
\mathpass@arg{\mathcal}


\mathpass@arg@arg{\binom}
\mathpass@arg@arg{\dbinom}
\mathpass@arg@arg{\tbinom}

\mathpass@arg@arg{\QATOP}
\mathpass@arg@arg{\QTATOP}
\mathpass@arg@arg{\QDATOP}

\mathpass@arg@arg@arg{\QABOVE}
\mathpass@arg@arg@arg{\QTABOVE}
\mathpass@arg@arg@arg{\QDABOVE}
\mathpass@arg@arg@arg@arg{\QOVERD}
\mathpass@arg@arg@arg@arg{\QTOVERD}
\mathpass@arg@arg@arg@arg{\QDOVERD}
\mathpass@arg@arg@arg@arg{\QATOPD}
\mathpass@arg@arg@arg{\QTATOPD}
\mathpass@arg@arg@arg{\QDATOPD}
%  \mathpass@arg@arg@arg{}
%  \mathpass@arg@arg@arg{}
%  \mathpass@arg@arg@arg{}
%  


%\def\QABOVED#1#2#3#4#5{{#4 \abovewithdelims#1#2#3 #5}}%
%  \def\QTABOVED#1#2#3#4#5{{\textstyle 
%     {#4 \abovewithdelims#1#2#3 #5}}}%
%  \def\QDABOVED#1#2#3#4#5{{\displaystyle 
%     {#4 \abovewithdelims#1#2#3 #5}}}%
%  

\def\unit#1{\string\unit\@brace{#1}}

\MSIMathQuote{\QABOVED} % special case? Why is this here?


\def\text#1{\msitag{\text{#1}}}

\def\vspace#1{%
   \ifmmode
     \string\vspace\@brace{#1}%
   \else
     \msitag{<vspace dim="#1" type="customSpace"></vspace>}%
   \fi
}



\def\MSICounter#1{%
  \expandafter\newcount\csname c@#1\endcsname}

\def\&{\char`\&amp;}
\def\|{\Vert}



\def\out@hyperref#1#2#3#4{%
   \msiopentag{<a href="#4">}#1\msiclosetag{</a>}%
}

\newif\if@in@texttag
\@in@texttagfalse

\def\QTP#1{%
  \par
  \msihmode
  \msiopentag{QTP}{<QTP type="#1">}%
  \begingroup
    \def\par{\msiclosetag{QTP}{</QTP>}\endgroup}%
}

\def\@ttclose#1{\msiclosetag{#1}{</#1>}}
\def\@closelasttexttag{\expandafter\@ttclose\expandafter{\@lasttexttag}}

\def\MSIFontSwitch{%
  \@ifnextchar[{\msi@font@switchA}{\msi@font@switchB}}


\def\msi@font@switchA[#1]#2{%
   \expandafter\def\csname#2\endcsname{%
      \ifmmode
        \char`\\\msitag{#2}%
      \else
        \msihmode
        \if@in@texttag
           \expandafter\@ttclose\expandafter{\@lasttexttag}%
        \else
           \@in@texttagtrue
        \fi
        \gdef\@lasttexttag{#1}%
        \msiopentag{#1}{<#1>}%
        \aftergroup\@closelasttexttag
      \fi
   }
}

\def\msi@font@switchB#1{\msi@font@switchA[#1]{#1}}


\def\MSITextElement{%
  \@ifnextchar[{\msi@text@elmA}{\msi@text@elmB}}

\def\msi@text@elmA[#1]#2{%
  \expandafter\def\csname #2\endcsname##1{%
     \msihmode\msiopentag{#1}{<#1>}##1\msiclosetag{#1}{</#1>}}}

\def\msi@text@elmB#1{\msi@text@elmA[#1]{#1}}



%% Create TeX Buttons

\def\MSITeXButtonReq#1{
    \expandafter\def\csname#1\endcsname##1{
       \msihmode
       \msitag{<texb enc="1" name="#1">}%
          <![CDATA[\expandafter\string\csname#1\endcsname\{##1\}]]>%
       \msitag{</texb>}}}


%% Various note type things

\def\@start@notewrapper{%
    \msiopentag{notewrapper}{<notewrapper xmlns="http://www.w3.org/1999/xhtml">}}

\def\@end@notewrapper{%
    \msiclosetag{notewrapper}{</notewrapper>}}

\def\@end@footnote{\msiclosetag{note}{</note>}\@end@notewrapper}
\def\@innote{\bgroup\aftergroup\@end@footnote}

%%<note type="#2">


\def\footnote{%
    \br\@start@notewrapper
    \msiopentag{note}{<note type="footnote">}
    \afterassignment\@footnoteb
    \let\junk
}
\def\@footnoteb{
    \bgroup
    \aftergroup\@footnotec
}

\def\@footnotec{
    \msiclosetag{note}{</note>}%
    \@end@notewrapper}

\def\out@CustomNoteA[#1]#2#3{%
    \msiopentag{notewrapper}{<notewrapper xmlns="http://www.w3.org/1999/xhtml">}%
    \msiopentag{note}{<note type="#2">}%
    \bgroup
      \@in@texttagfalse% turn this off so we don't close pending tags if we nest a font switch. 
      #3%
    \egroup
    \msiclosetag{note}{</note>}%
    \msiclosetag{notewrapper}{</notewrapper>}%
}

\def\out@CustomNoteB#1#2{%
    \msiopentag{notewrapper}{<notewrapper xmlns="http://www.w3.org/1999/xhtml">}%
    \msiopentag{note}{<note type="#1">}%
    \bgroup
      \@in@texttagfalse% turn this off so we don't close pending tags if we nest a font switch. 
      #2%
    \egroup
    \msiclosetag{note}{</note>}%
    \msiclosetag{notewrapper}{</notewrapper>}%
}



%% \def\msi@opendocument{%
%%    \msitag{<?xml version="1.0"?>}\br
%%    
%%    \msitag{<!DOCTYPE swxml PUBLIC
%%      "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
%%      "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"
%%      [
%%       <!ATTLIST maction id ID ##IMPLIED>
%%       <!ENTITY mathml "http://www.w3.org/1998/Math/MathML">
%%      ]>}\br
%%    
%%    \msitag{<?xml-stylesheet href="StandardLaTeXArticle.css" type="text/css"?>}\br
%%    \msiopentag{document}{<document xmlns:sw="http://www.sciword.com/namespaces/sciword" xmlns:mml="http://www.w3.org/1998/Math/MathML" type="latex">}\br
%%    \msiopentag{preamble}{<preamble>}
%% }

%% Temporary until prince can read xml

\def\msi@opendocument{%
   \msitag{<?xml version="1.0"?>}\br
   \msitag{<?xml-stylesheet href="css/my.css" type="text/css"?>}\br
   \msitag{<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd">}
   
  \br\msitag{<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:mml="http://www.w3.org/1998/Math/MathML"
      xmlns:sw="http://www.sciword.com/namespaces/sciword">}
   
   \br\msitag{<head>}
   \br\msiopentag{preamble}{<preamble>}
}


\input latex-default.tex
\input tcilatex.tex