\makeatletter

\newcounter{MaxMatrixCols}

\msi@inpreamble = 0


%%\def\msiToPreamble#1{\expandafter\preambleToks\expandafter{\the\preambleToks #1}}



\def\msi@rfi#1#2{\def#1{\msitag{<requestimplementation>#2</requestimplementation>}}}

\def\href#1#2{%
   \ifmmode
      \msitag{\msipassthru{<a href="#1">#2</a>}}%
   \else
      \msiopentag{a}{<a href="#1">}#2\msiclosetag{a}{</a>}%
   \fi}


% This writes the css file my.css. 
% Do this at the end because it happens that we don't know what css are required. 
 
\def\msimakecss{
   \def\css{2}	  % the css output file
   \openout\css={css/my.css} %% the CSS style file for this document
   \write\css{@import url("resource://app/res/css/baselatex.css");}
   \write\css{@import url("resource://app/res/css/latex.css");}
   \write\css{\classcss}
   \write\css{\newtheorems}
   \closeout\css
}

\def\classcss{}
\def\newtheorems{}

\msi@dollar=`\$

\def\msi@pass#1{\def#1{\msitag{<texb>#1</texb>}}}
\def\msi@pass@newline#1{\def#1{\br\msihmode\msitag{<texb>#1</texb>}}}

\msi@pass@newline{\@settodim}
\msi@pass@newline{\settoheight}
\msi@pass@newline{\settodepth}
\msi@pass@newline{\settowidth}

%\def\leftline#1{\@@line{#1\hss}}
%\def\rightline#1{\@@line{\hss#1}}
%\def\centerline#1{#1}


\def\MSIMathQuote#1{%
   %\expandafter\def\csname#1\endcsname{\char`\\#1\char32\relax}}
   \expandafter\def\csname#1\endcsname{\expandafter\string\csname#1\endcsname\char32\relax}}

% \newcounter{#1}[#2]

\newtoks\preambleToks


%% redefine these to produce output

\def\newcounter#1{%
  \msihmode
  \msiopentag{texb}{<texb enc="1" name="newcounter">}
       \msitag{<![CDATA[\newcounter{#1}]]>}%
  \msiclosetag{texb}{</texb>}}
}

\def\setcounter#1#2{%
    \expandafter\global\csname c@#1\endcsname#2\relax
    \msihmode
    \msiopentag{texb}{<texb enc="1" name="setcounter">}
       \msitag{<![CDATA[\setcounter{#1}{#2}]]>}%
    \msiclosetag{texb}{</texb>}}

\def\addtocounter#1#2{%
    \expandafter\global\advance\csname c@#1\endcsname #2\relax
    \msihmode
    \msiopentag{texb}{<texb enc="1" name="addtocounter">}
       \msitag{<![CDATA[\addtocounter{#1}{#2}]]>}%
    \msiclosetag{texb}{</texb>}}


\msi@inline@proc={jbm}
\msi@display@proc{jbm}


\msi@everyrowstart{\msiopentag{tr}{<tr>}}
\msi@everyrowend{\msiclosetag{tr}{</tr>}}


\msi@everycellstart{%
   \msiclosetag{td}{</td>}%
   \msiopentag{td}{<td>}%
   \ifmmode\else\msiopentag{bodyText}{<bodyText>}\fi}


\msi@everycellend{%
   \ifmmode
   \else
      \msitag{<br type="_moz"/>}%
   \fi
   \msiclosetag{td}{</td>}}

\def\msi@stylesheets{\msitag{<?xml-stylesheet href="css/my.css" type="text/css"?>}\br}


\def\@brace#1{\char123\relax#1\char125\relax}

\def\br{\msitag{^^0a}}


%% \documentclass.
\newif\ifmsi@firstopt
\msi@firstopttrue

% ["pgorient", "papersize", "sides", "qual", "columns", "titlepage", "textsize", "eqnnopos", "eqnpos", "bibstyle"];

\expandafter\def\csname 10ptAttrib\endcsname{textsize="10pt"}
\expandafter\def\csname 11ptAttrib\endcsname{textsize="11pt"}
\expandafter\def\csname 12ptAttrib\endcsname{textsize="12pt"}

%\expandafter\def\csname portAttrib\endcsname{pgorient="port"}
\expandafter\def\csname landscapeAttrib\endcsname{pgorient="landscape"}

\expandafter\def\csname letterpaperAttrib\endcsname{papersize="letter"}
\expandafter\def\csname a4paperAttrib\endcsname{papersize="a4paper"}
\expandafter\def\csname a5paperAttrib\endcsname{papersize="a5paper"}
\expandafter\def\csname b5paperAttrib\endcsname{papersize="b5paper"}
\expandafter\def\csname legalpaperAttrib\endcsname{papersize="legalpaper"}
\expandafter\def\csname executivepaperAttrib\endcsname{papersize="executivepaper"}

\expandafter\def\csname twosideAttrib\endcsname{sides="twoside"}
\expandafter\def\csname onesideAttrib\endcsname{sides="oneside"}

\expandafter\def\csname finalAttrib\endcsname{qual="final"}
\expandafter\def\csname draftAttrib\endcsname{qual="draft"}

\expandafter\def\csname onecolumnAttrib\endcsname{columns="1"}
\expandafter\def\csname twocolumnAttrib\endcsname{columns="2"}

\expandafter\def\csname leqnoAttrib\endcsname{eqnnopos="leqno"}
\expandafter\def\csname reqnoAttrib\endcsname{eqnnopos="reqno"}

\expandafter\def\csname fleqnAttrib\endcsname{eqnpos="fleqn"}

\newtoks\temptoksb

\def\msiappend#1MSIXYZZY{%
   \expandafter\temptoksa\expandafter{\the\temptoksa #1}}

\def\msi@nextopt#1,{%
   \def\MSIXYZZY{MSIXYZZY}%
   \def\@Opt{#1}%
   \ifx\@Opt\MSIXYZZY%
      \let\@next\relax
   \else
      \ifmsi@firstopt
         \msi@firstoptfalse
      \else
         \expandafter\temptoksa\expandafter{\the\temptoksa\ }%
      \fi
      \edef\attrib{\csname #1Attrib\endcsname}%
      \expandafter\temptoksb\expandafter{\attrib}
      \expandafter\msiappend\the\temptoksb MSIXYZZY
      \let\@next\msi@nextopt
   \fi
   \@next}

\def\out@documentclassA[#1]#2{%
   %\msi@firstopttrue
   %\temptoksa={}%
   %\msi@nextopt#1,MSIXYZZY,%
   %\edef\colist{\the\temptoksa}%
   \msi@opendocument
   \temptoksa{#1}
   \ifx\temptoksa\relax
     \br\msitag{<documentclass class="#2"/>}%
   \else
     \br\msitag{<documentclass class="#2" options="#1"/>}%
   \fi}

\def\out@documentclassB#1{%
   \msi@opendocument
   \br\msitag{<documentclass class="#1"/>}}



\def\out@preamble@tex#1{%
   \msitag{<preambleTeX><![CDATA[#1]]></preambleTeX>}}


%% \document and \enddocument

\def\out@begin@document{%
   %\br\msiopentag{docformat}{<docformat>}
   %   \msitag{<colist }\colist\msitag{/>}
   %\br\msiclosetag{docformat}{</docformat>}
   \expandafter\preambleToks\expandafter{\the\preambleToks^^0a\usepackage{bm}}%
   \expandafter\preambleToks\expandafter{\the\preambleToks^^0a\usepackage{tabulary}}%
%   \@ifundefined{@TCILATEX}
%     {\relax}
%     {\expandafter\preambleToks\expandafter{\the\preambleToks^^0a\input{tcilatex}}}
   \expandafter\out@preamble@tex\expandafter{\the\preambleToks}
   \msiclosetag{preamble}{</preamble>}%
   \msi@inpreamble = 0
   \br\msitag{</head>}
   \br\msiopentag{body}{<body>}
   %%\msihmode\br\msiopentag{docbody}{<docbody>}%
   \msipreambleextra
   \@paragraphs
   \msivmode
}

\def\out@end@document{%
   %%\br\msiclosetag{docbody}{</docbody>}%
   \br\msiclosetag{body}{</body>}%
   \br\msitag{</html>}%
   \msimakecss
   \endinput}


%% \usepackage
\def\out@usepackageA[#1]#2{%
   \br\msitag{<usepackage req="#2" options="#1"/>}}

\def\out@usepackageB#1{%
   \br\msitag{<usepackage req="#1"/>}}


%% Frontmatter

\def\title{%
  \@ifnextchar[{\@titlea}{\@titleb}}

\def\@titlea[#1]#2{%
  \msiopentag{title}{<title>}%
    \msiopentag{short}{<short>}%
      #1%
    \msiclosetag{short}{</short>}%
    \msiopentag{long}{<long>}%
      #2%
    \msiclosetag{long}{</long>}%
  \msiclosetag{title}{</title>}%
}

\def\@titleb#1{%
   \msiopentag{title}{<title>}#1\msiclosetag{title}{</title>}}

\def\author#1{\gdef\@author{#1}\out@author{#1}}

\def\date{\@ifnextchar[{\dateA}{\dateB}}
\def\dateA[#1]#2{%
   \gdef\@date{#2}\out@dateA{#1}{#2}}
\def\dateB#1{\gdef\@date{#1}\out@date{#1}}

\def\thanks#1{\out@thanks{#1}}
\def\and{\out@and}

%\def\frontmatter{\out@frontmatter}
%\def\mainmatter{\out@mainmatter}

\def\out@title#1{%
   {\everypar={}\msitag{^^0a}\msiopentag{title}{<title>}#1\msiclosetag{title}{</title>}}}

\def\out@thanks#1{%
   \msitag{^^0a}\msiopentag{thanks}{<thanks>}#1\msiclosetag{thanks}{</thanks>}}

\def\out@and{\msiclosetag{author}{</author>}\msitag{^^0a}\msiopentag{author}{<author>}}%

\def\out@author#1{%
  \begingroup
   \def\\{\msitag{^^0a}%
          \msiclosetag{author}{</author>}
          \msitag{^^0a}%
          \msiopentag{address}{<address>}\ignorespaces}%
   \def\and{\msiclosetag{address}{</address>}%
            \msiclosetag{author}{</author>}\msitag{^^0a}\msiopentag{author}{<author>}}%
   \msitag{^^0a}%
   \msiopentag{author}{<author>}#1\msiclosetag{author}{</author>}\msiclosetag{address}{</address>}%
  \endgroup
}

\def\out@date#1{%
   \msihmode\br\msiopentag{date}{<date>}#1\msiclosetag{date}{</date>}}

\def\out@dateA#1#2{%
   \msihmode\br
   \msiopentag{date}{<date>}%
      #2%
      \msiopentag{option}{<option>}%
         #1%
      \msiclosetag{option}{</option>}%
   \msiclosetag{date}{</date>}}

\def\MSIEmptyElement{%
  \@ifnextchar[{\msi@empty@elmA}{\msi@empty@elmB}}

\def\msi@empty@elmA[#1]#2{%
     \expandafter\def\csname #2\endcsname{%
        \ifmmode
           %\msitag{\msipassthru{<#1/>}}%
           \expandafter\msitag\expandafter{\csname#2\endcsname}%
        \else
           \msihmode\br\msitag{<#1/>}%
        \fi}}

\def\msi@empty@elmB#1{\msi@empty@elmA[#1]{#1}}


\def\MSISimpleEnvironment{%
  \@ifnextchar[{\msi@simple@envA}{\msi@simple@envB}}

\def\msi@simple@envA[#1]#2{%
  \expandafter\def\csname msi@begin@#2\endcsname{\msiopentag{#1}{<#1>}\msihmode}%
  \expandafter\def\csname msi@end@#2\endcsname{\msiclosetag{#1}{</#1>}}}

\def\msi@simple@envB#1{\msi@simple@envA[#1]{#1}}



%% newtheorem

\def\theoremstyle#1{\def\msi@currentthmstyle{#1}}
\theoremstyle{plain}


% should check for second optional
\def\out@newtheorema#1[#2]#3{%
  \msitag{<newtheorem name="#1" style = "}\msi@currentthmstyle\msitag{" counter="#2" label="#3"/>}%
  \@ifundefined{msi@begin@#1}%
    {\@namedef{msi@begin@#1}{\br\msiopentag{#1}{<#1>}\msihmode}%
     \@namedef{msi@end@#1}{\br\msiclosetag{#1}{</#1>}}}%
    {}}

\def\out@newtheoremb#1#2{%
  \@ifundefined{msi@begin@#1}%
    {\msitag{<newtheorem name="#1" style = "}\msi@currentthmstyle\msitag{" label="#2"/>}%
     \@namedef{msi@begin@#1}{\br\msiopentag{#1}{<#1>}\msihmode}%
     \@namedef{msi@end@#1}{\br\msiclosetag{#1}{</#1>}}}%
    {}}

%% recheck this one
\def\out@newtheoremc#1#2[#3]{%
  \msitag{<newtheorem name="#1" style = "}\msi@currentthmstyle\msitag{" label="#2"/>}%
  \@ifundefined{msi@begin@#1}%
    {\@namedef{msi@begin@#1}{\br\msiopentag{#1}{<#1>}\msihmode}%
     \@namedef{msi@end@#1}{\br\msiclosetag{#1}{</#1>}}}%
    {}}



% Forms of the \newenvironment command
\def\newenvironment{%
   \@ifnextchar*{\@newenvironment{*}}{\@newenvironment{}}}

 
\def\@newenvironment#1#2{%
   \@ifnextchar[{\@newenv@a{#1}{#2}}{\@newenv@a{#1}{#2}[]}}


\def\@newenv@a#1#2[#3]{%
   \@ifnextchar[{\@newenv@b{#1}{#2}[#3]}{\@newenv@b{#1}{#2}[#3][]}}

\def\@newenv@b#1#2[#3][#4]#5#6{%
    \expandafter\preambleToks\expandafter{\the\preambleToks^^0a\newenvironment{#2}[#3][#4]{#5}{#6}}%
    \@ifundefined{msi@begin@#2}%
      {\@namedef{msi@begin@#2}{\msi@open@element<#2>}}%
      {\@namedef{msi@end@#2}{\msi@close@element</#2>}}}%


%% %% Newcommand and renewcommand
 
 \def\newcommand{\@ifnextchar*{\@newcommand}{\@newcommand{}}}
 \let\renewcommand\newcommand
 \let\providecommand\newcommand
 
 
 %%% #1 = optional star, #2 = command name
 \def\@newcommand#1#2{\@ifnextchar[{\@newcommandA{#1}{#2}}{\@newcommandA{#1}{#2}[1]}}
 
 \def\@newcommandA#1#2[#3]{\@ifnextchar[{\@newcommandB{#1}{#2}[#3]}{\@newcommandB{#1}{#2}[#3][]}}

 \def\@newcommandB#1#2[#3][#4]#5{%
   \expandafter\preambleToks\expandafter{\the\preambleToks^^0a\newcommand#1{#2}[#3][#4]{#5}}%
   \MSILocalDef{#2}}



%% Citations and cross refs

\def\attrib@text{
  \catcode`\&=\active
  \catcode`\<=\active
  \catcode`\>=\active
}

\def\cite{%
  \msihmode
  \@ifnextchar[{\@tempswatrue\begingroup\attrib@text\out@citex}{\@tempswafalse\begingroup\attrib@text\out@citey}}


%\def\@citey#1#{%
%  \attrib@text\out@citey
%}


\def\out@citex[#1]#2{%
   \msiopentag{citation}{<citation xmlns="http://www.w3.org/1999/xhtml" 
                            citekey="}#2\msitag{" 
                            hasRemark="true">}%
        \msiopentag{biblabel}{<biblabel class="remark" xmlns="http://www.w3.org/1999/xhtml">}%
            #1%
        \msiclosetag{biblabel}{</biblabel>}%
  \msiclosetag{citation}{</citation>}
  \endgroup}

\def\out@citey#1{%
  \msiopentag{citation}{<citation xmlns="http://www.w3.org/1999/xhtml" 
                                  citekey="}#1\msitag{" hasRemark="false">}%
  \msiclosetag{citation}{</citation>}
  \endgroup}


%\MSITextElement[a]{ref}
%%<xref key="mykey" reftype="page" req="varioref"/>
%\MSITextElement{pageref}

\def\ref#1{%
  \ifmmode
    \msitag{\msipassthru{<xref key="#1" reftype="obj" req="varioref"/>}}%
  \else
    \msitag{<xref key="#1" reftype="obj" req="varioref"/>}
  \fi}

\def\pageref#1{%
  \ifmmode
    \msitag{\msipassthru{<xref key="#1" reftype="page" req="varioref"/>}}%
  \else
    \msitag{<xref key="#1" reftype="page" req="varioref"/>}
  \fi}



\def\msi@pass#1{\def#1{\msitag{#1}}}

\def\@descr{descriptionListItem}
\def\@enumerate{numberedListItem}
\def\@bullet{bulletListItem}
\newif\if@first@item

\def\out@itema[#1]{
   \if@first@item
     \@first@itemfalse
   \else
     \def\enditemtag##1{\msiclosetag{##1}{</##1>}}%
     \expandafter\enditemtag\expandafter{\itemprefix}%
   \fi
   \def\startitemtag##1{\br\msihmode\msiopentag{##1}{<##1>}\msiopentag{bodyText}{<bodyText>}}%
   \expandafter\startitemtag\expandafter{\itemprefix}%
   \ifx\itemprefix\@descr
     \msitag{<descriptionLabel>}#1\msitag{</descriptionLabel>}%
   \else
     \ifx\itemprefix\@enumerate
       \msitag{<numberedLabel>}#1\msitag{</numberedLabel>}%
	 \else
       \ifx\itemprefix\@bullet
         \msitag{<bulletLabel>}#1\msitag{</bulletLabel>}%
	   \else
         \msitag{<explicit-item>}#1\msitag{</explicit-item>}%
	   \fi
	 \fi
   \fi
}

\def\out@itemb{
   \if@first@item
     \@first@itemfalse
   \else
     \def\enditemtag##1{\msiclosetag{##1}{</##1>}}%
     \expandafter\enditemtag\expandafter{\itemprefix}%
   \fi
   \def\startitemtag##1{\br\msihmode\msiopentag{##1}{<##1>}\msiopentag{bodyText}{<bodyText>}}%
   \expandafter\startitemtag\expandafter{\itemprefix}%
}


\def\out@bibitemA[#1]#2{%
   \if@first@item
     \@first@itemfalse
   \else
     \msiclosetag{bodyText}{</bodyText>}%
     \msiclosetag{bibitem}{</bibitem>}%
   \fi
   \br\msihmode\msiopentag{bibitem}{}<bibitem bibtemkey="#2" hasLabel="true">%
   \msitag{<biblabel class="bibitemlabel">}#1\msitag{</biblabel>}%
   \br\msiopentag{bodyText}{<bodyText>}%
   \endgroup
}

\def\out@bibitemB#1{%
   \if@first@item
     \@first@itemfalse
   \else
     \msiclosetag{bodyText}{</bodyText>}%
     \msiclosetag{bibitem}{</bibitem>}%
   \fi
   \br\msiopentag{bibitem}{<bibitem bibitemkey="}#1\msitag{" hasLabel="false">}%
   \br\msiopentag{bodyText}{<bodyText>}
   \endgroup%
}


\def\@closeitem{\msiclosetag{li}{</li>}}
\def\@openitem{\msiopentag{li}{<li>}}


% A default item name
\def\itemprefix{item}

% #1=xml name, #2=latex env name, #3=xml item name
\def\MSIListEnvironment#1#2#3{%
   \expandafter\def\csname msi@begin@#2\endcsname{%
      \def\itemprefix{#3}%
      \everypar={}\msihmode\msitag{^^0a^^0a}\@first@itemtrue\msiopentag{#1}{<#1>}}

   \expandafter\def\csname msi@end@#2\endcsname{%
      \br\msiclosetag{#1}{</#1>}}
}



\def\msi@begin@thebibliography#1{%
  \everypar={}%
  \msihmode\msitag{^^0a^^0a}%
  \@first@itemtrue
  \msiopentag{bibliography}{<bibliography>}}

\def\msi@end@thebibliography{%
  \br\msiclosetag{bibliography}{</bibliography>}}


\def\msi@thm@like#1{}



%\input msiframe.tex



%% \def\[#1\]{%
%%   \msitag{<mml:math>}
%%   \msiextproc{jbm}{$#1$}%
%%   \msitag{</mml:math>}
%% }
%% 


\newcount\seclevel
\seclevel=0

\newif\if@starred
\def\@gobble#1{}


%% Sectioning

% We always use <sectiontitle> rather than #4
\def\newsection#1#2#3#4{%
  \expandafter\newcount\csname#1number\endcsname
  \csname#1number\endcsname=0
  \expandafter\def\csname the#1\endcsname{#3}%
  \expandafter\def\csname #1\endcsname{%
     \@ifnextchar*{\@starredtrue\csname @#1\endcsname}%
                  {\@starredfalse\csname @#1\endcsname *}%
  }
  \expandafter\def\csname @#1\endcsname*{%
     \@ifnextchar[{\csname @@#1\endcsname}%
                  {\csname @@#1\endcsname[]}%
  }
  \expandafter\def\csname @@#1\endcsname[##1]##2{%
     \seclevel=#2%
     \expandafter\advance\csname #1number\endcsname by 1%
     \let\protect\relax
     \msiclosetag{#1}{</#1>}%
     \msitag{^^0a}%
     \if@starred
       \msiopentag{#1}{<#1 nonum="true">}%
     \else 
       \msiopentag{#1}{<#1>}%
     \fi
     {\everypar={}\msitag{^^0a}%
      \def\short{##1}%
      \msiopentag{sectiontitle}{<sectiontitle>}%
      \ifx\short\@empty
      \else
        \msiopentag{shortTitle}{<shortTitle>}%
          ##1%
        \msiclosetag{shortTitle}{</shortTitle>}%
      \fi
      ##2%
      \msiclosetag{sectiontitle}{</sectiontitle>}}%
  }%
}




\newsection{part}{1}{Part \the\sectionnumber}{sectiontitle}%
\newsection{chapter}{2}{Chapter \the\sectionnumber}{sectiontitle}%
\newsection{section}{2}{Section \the\sectionnumber}{sectiontitle}%
\newsection{subsection}{3}{\the\sectionnumber.\the\subsectionnumber}{sectiontitle}%
\newsection{subsubsection}{4}{\thesectionnumber.\thesubsectionnumber.\the\subsubsectionnumber}{sectiontitle}%
\newsection{paragraph}{5}{\thesectionnumber.\thesubsectionnumber.\the\subsubsectionnumber.\the\paragraphnumber}{sectiontitle}%
\newsection{subparagraph}{6}{\thesectionnumber.\thesubsectionnumber.\the\subsubsectionnumber.\the\paragraphnumber}{sectiontitle}%


\def\out@marginparA#1#2{%
  \@start@notewrapper
  \msiopentag{note}{<note type="marginpar" opt="#1">}%
    \msiopentag{bodyText}{<bodyText>}%
      #2%
    \msiclosetag{bodyText}{</bodyText>}%
  \msiclosetag{note}{</note>}%
  \@end@notewrapper
}

\def\out@marginparB#1{%
  \@start@notewrapper
  \msiopentag{note}{<note type="marginpar">}%
    \msiopentag{bodyText}{<bodyText>}%
      #1%
    \msiclosetag{bodyText}{</bodyText>}%
  \msiclosetag{note}{</note>}%
  \@end@notewrapper
}

\def\rule{%
  \@ifnextchar[{\@rulea}{\@ruleb}}%
\def\@rulea[#1]#2#3{%
  \ifmmode
     \string\rule[#1]\char123#2\char125\char123#3\char125
  \else
    \msitag{<msirule lift="#1" width="#2" height="#3" %
                     style="vertical-align: #1; width: #2; height: #3; background-color: rgb(0, 0, 0);"/>}%
  \fi
}
\def\@ruleb#1#2{%
  \ifmmode
    \string\rule\char123#1\char125\char123#2\char125
  \else
    \msitag{<msirule lift="0" width="#1" height="#2" %
                     style="vertical-align: 0; width: #1; height: #2; background-color: rgb(0, 0, 0);"/>}%
  \fi
}

\def\hspace{%
   \@ifnextchar*{\@hspacestar}{\@hspace}}

\def\@hspace#1{
   \ifmmode
     \string\hspace\@brace{#1}%
   \else
     \msitag{<hspace dim="#1" type="customSpace"></hspace>}%
   \fi
}

\def\@hspacestar#1#2{
   \@hspace{#2}%
}

\def\@paragraphs{%
  \let\@par\par
  \def\par{\msiclosetag{bodyText}{</bodyText>}\@par}%
  \everypar{\msihmode\br\msiopentag{bodyText}{<bodyText>}}%
}


\everymath{%
   %\catcode`\&=13 %
   \catcode`\'=\active
   \aftergroup\endmath
}
\def\endmath{}

\everydisplay{%
  %\catcode`\&=13 %
  \catcode`\'=\active
  \aftergroup\enddisplay
}
\def\enddisplay{}


\def\@make@braces@other{%
  \catcode`\{=12%
  \catcode`\}=12%
  \relax
}
\def\@make@braces@normal{%
  \catcode`\{=1%
  \catcode`\}=2%
  \relax
}

\bgroup
  \catcode`\^^M=13\relax
  \gdef^^M{\char13\char10\relax}%
\egroup


%  \def\@make@linebreak@other{%
%    \catcode`\^^M=13\relax
%  }
%
%  \def\@make@linebreak@normal{%
%    \catcode`\^^M=5\relax
%  }


\def\linebreak{\msitag{<msibreak type="lineBreak" invisDisplay="&##x21b5;"><br/></msibreak>}}

\def\newline{%
  \@ifnextchar[{\newlinea}{\newlineb}}

\def\newlinea[#1]{\msitag{<msibreak type="newLine" invisDisplay="&##x21b5;"><br/></msibreak>}}

\def\newlineb{\msitag{<msibreak type="newLine" invisDisplay="&##x21b5;"><br/></msibreak>}}

\newtoks\temptoksa


\bgroup
  \@make@braces@other
  \catcode`\[=1
  \catcode`\]=2

  \gdef\@scan@align@star#1\end{align*}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{align*}#1\end{align*}]%
     \msiclosetag[mml][</mml:math>]
  ]
  \gdef\@scan@align#1\end{align}[%
     \egroup
     \@make@braces@normal
     \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
     \msiextproc[jbm][\begin{align}#1\end{align}]%
     \msiclosetag[mml][</mml:math>]
  ]

  %\gdef\@scan@equation@star#1\end{equation*}[%
  %   \egroup
  %   \@make@braces@normal
  %   \msiopentag[mml][<mml:math class="displayedmathml" mode="display" display="block">]%
  %   \msiextproc[jbm][\begin{equation*}#1\end{equation*}]%
  %   \msiclosetag[mml][</mml:math>]
  %]
  %\gdef\@scan@array#1\end{array}[%
  %   \egroup
  %   \@make@braces@normal
  %   \msitag[\begin{array}#1\end{array}]
  %]
  %\def\endarray[\cr\egroup\string\end`\{array\char`\}]
  \gdef\@scan@bmatrix#1\end{bmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{bmatrix}#1\end{bmatrix}]
     %\temptoksa=[\begin{bmatrix}#1\end{bmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@Bmatrix#1\end{Bmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{Bmatrix}#1\end{Bmatrix}]
     %\temptoksa=[\begin{Bmatrix}#1\end{Bmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@smallmatrix#1\end{smallmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{smallmatrix}#1\end{smallmatrix}]
  ]

  \gdef\@scan@vmatrix#1\end{vmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{vmatrix}#1\end{vmatrix}]
     %\temptoksa=[\begin{vmatrix}#1\end{vmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@Vmatrix#1\end{Vmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{Vmatrix}#1\end{Vmatrix}]
     %\temptoksa=[\begin{Vmatrix}#1\end{Vmatrix}]%
     %\the\temptoksa
  ]
  \gdef\@scan@pmatrix#1\end{pmatrix}[%
     \egroup
     \@make@braces@normal
     \msitag[\begin{pmatrix}#1\end{pmatrix}]
     %\temptoksa=[\begin{pmatrix}#1\end{pmatrix}]%
     %\the\temptoksa
  ]
\egroup


%\@namedef{msi@begin@multline*}{\ \@make@braces@other\relax\@scan@multline@star}



\@namedef{msi@begin@flalign}{\bgroup\msi@dollar=0\relax$$\string\begin{flalign}}
\@namedef{msi@end@flalign}{\string\end{flalign}$$\egroup}

\@namedef{msi@begin@flalign*}{\bgroup\msi@dollar=0\relax$$\string\begin{flalign*}}
\@namedef{msi@end@flalign*}{\string\end{flalign*}$$\egroup}

\@namedef{msi@begin@alignat}{\bgroup\msi@dollar=0\relax$$\string\begin{alignat}}
\@namedef{msi@end@alignat}{\string\end{alignat}$$\egroup}

\def\msi@begin@math{\bgroup\msi@dollar=0\relax$\string\begin{math}}
\def\msi@end@math{\string\end{math}$\egroup}


\def\msi@begin@equation{\bgroup\msi@dollar=0\relax$$\string\begin{equation}}
\def\msi@end@equation{\string\end{equation}$$\egroup}


\@namedef{msi@begin@equation*}{\bgroup\msi@dollar=0\relax$$\string\begin{equation*}}
\@namedef{msi@end@equation*}{\string\end{equation*}$$\egroup}

\@namedef{msi@begin@displaymath}{\bgroup\msi@dollar=0\relax$$\string\begin{equation*}}
\@namedef{msi@end@displaymath}{\string\end{equation*}$$\egroup}


\def\msi@begin@array{\begingroup\def\\{\char`\\\char`\\}\catcode`\&=12\string\begin{array}}
\def\msi@end@array{\string\end{array}\endgroup}


%\def\@label#1{\msikilllasttag{<tr>}{<tr marker="#1" style="">}}%

\def\MSIEqnarrayLikeEnvironment#1{%
  \@namedef{msi@begin@#1}{%
     \bgroup
        \def\\{\char`\\\char`\\}%
%        \let\label\@label
        \catcode`\&=12\msi@dollar=0\relax$$%
        \string\begin{#1}}%
  \@namedef{msi@end@#1}{\string\end{#1}$$\egroup}}



\def\MSISplitLikeEnvironment#1{%
  \@namedef{msi@begin@#1}{
    \bgroup
      \def\\{\char`\\\char`\\}%
      \ifmmode
      \else
         \msi@dollar=0\relax$$
      \fi
      \string\begin{#1}\catcode`\&=12}%
  \@namedef{msi@end@#1}{%
      \string\end{#1}%
      \ifmmode
      \else
         $$
      \fi
    \egroup}}




\@namedef{msi@begin@align*}{\ \@make@braces@other\relax\@scan@align@star}
\@namedef{msi@begin@align}{\ \@make@braces@other\relax\@scan@align}



\def\msi@begin@bmatrix{\@make@braces@other\relax\@scan@bmatrix} 
\def\msi@begin@Bmatrix{\@make@braces@other\relax\@scan@Bmatrix} 
\def\msi@begin@smallmatrix{\@make@braces@other\relax\@scan@smallmatrix} 
\def\msi@begin@vmatrix{\@make@braces@other\relax\@scan@vmatrix} 
\def\msi@begin@Vmatrix{\@make@braces@other\relax\@scan@Vmatrix} 
\def\msi@begin@pmatrix{\@make@braces@other\relax\@scan@pmatrix}



{\catcode`\^^M=\active % these lines must end with %
  \gdef\obeylines{\catcode`\^^M\active \let^^M\par}%
  \global\let^^M\par} % this is in case ^^M appears in a \write
\def\obeyspaces{\catcode`\ \active}
\def\space{ }
{\obeyspaces\global\let =\space}

 

\def\@cr{\ifmmode
           \def\do@cr{\char`\\}%
         \else
           \def\do@cr{\@ifnextchar[{\@cra}{\@crb}}%
         \fi
         \do@cr}


\def\@cra[#1]{\cr}%
\def\@crb{\cr}%


\def\tabularnewline{\\}


\def\MSITabularStarEnvironment#1{%
  \@namedef{msi@begin@#1}##1{%
      \@ifnextchar[{\msitabularstarA{##1}}%
                   {\msitabularstarB{##1}}}%
  \@namedef{msi@end@#1}{%
        \crcr
        \egroup % the \halign
     \endgroup % to do the closetabular
     \ifmathtabular\char`\}\fi
  \endgroup}
}

\def\msitabularstarA#1[#2]#3{%
   \begingroup
      \ifmmode
        \string\msipassthru\char`\{% 
        \mathtabulartrue
        \msihmode
        \catcode`\&=4%
      \else
        \mathtabularfalse
      \fi
      \msihmode\msiopentag{table}{<table opt="#2" _moz_resizing="true"  cellpadding="4" border="1">}%
      \br\msiopentag{tbody}{<tbody>}%
      \begingroup
        \aftergroup\msi@closetabular
        \let\\=\@cr
        \halign\bgroup&##\cr
}

\def\msitabularstarB#1#2{%
   \begingroup
      \ifmmode
        \string\msipassthru\char`\{% 
        \mathtabulartrue
        \msihmode
        \catcode`\&=4%
      \else
        \mathtabularfalse
      \fi
      \msihmode
      \msiopentag{table}{<table cellspacing="2" cellpadding="2" border="1">}%
      \msiopentag{tbody}{<tbody>}%
      \begingroup
        \aftergroup\msi@closetabular
        \let\\=\@cr
        \halign\bgroup&##\cr
}
 
\def\msi@begin@tabular{%
   \@ifnextchar[{\msi@begin@tabularA}{\msi@begin@tabularA[]}}

\expandafter\def\csname msi@begin@tabular*\endcsname{%
   \@ifnextchar[{\msi@begin@tabularA}{\msi@begin@tabularA[]}}


\newif\ifmathtabular
\mathtabulartrue

\def\msi@begin@tabularA[#1]#2{%
   \begingroup
      \ifmmode
        \string\msipassthru\char`\{% 
        \mathtabulartrue
        \msihmode
        \catcode`\&=4%
      \else
        \mathtabularfalse
        \msihmode
      \fi
      \msiopentag{table}{<table cols="#2" cellpadding="4" border="1" req="tabulary" _moz_resizing="true">}%
      \msiopentag{tbody}{<tbody>}%
      \begingroup
        \aftergroup\msi@closetabular
        \let\\=\@cr
        \def\tabularnewline{\\}%
        \halign\bgroup&##\cr}


\def\msi@closetabular{%
  \msiclosetag{tbody}{</tbody>}%
  \msiclosetag{table}{</table>}%
  \msitag{<br type="_moz"/>}
  \ifmathtabular
    \msiclosetag{bodyText}{</bodyText>}%
  \fi}


\def\msi@end@tabular{% 
        \crcr
        \egroup % the \halign
     \endgroup % to do the closetabular
     \ifmathtabular\char`\}\fi
  \endgroup}

\expandafter\def\csname msi@end@tabular*\endcsname{%
        \crcr
        \egroup % the \halign
     \endgroup % to do the closetabular
     \ifmathtabular\char`\}\fi
  \endgroup}


%\def\cline#1{\msitag{<cline/>}}
%\def\hline{\msitag{<hline/>}}

\def\hline{}
\def\cline#1{}


%%\def\multicolumn#1#2#3{%
%%   \count0=#1\relax
%%   \ifnum\count0=1
%%     #3
%%   \else
%%      %\msitag{ Unimplemented multicol }
%%      \msikilllasttag  % the td
%%      \msikilllasttag  % the body text
%%      \msiopentag{td}{<td rowspan="1" colspan="#1">}%
%%        \msiopentag{bodyText}{<bodyText>}%
%%        #3
%%        %\msiclosetag{bodyText}{</bodyText>}%
%%      %\msiclosetag{td}{</td>}%
%%   \fi
%%}

\def\multicolumn#1#2#3#{%
   \count0=#1\relax
   \ifnum\count0=1\relax
   \else
      \msikilllasttag{<td>}{<td rowspan="1" colspan="#1">}%
   \fi}

\def\endbrace{\char`\}}
\chardef\other=12
\chardef\active=13
\bgroup
   \catcode`&=\active
   \gdef&{\ifmmode\char`\&\else\char`\&amp;\fi}%
\egroup


\def\out@verbatim#1{%
  \br\msihmode
  \msiopentag{verbatim}{<verbatim>}%
  \msiopentag{bodyText}{<bodyText>}%
   #1%
  \msiclosetag{bodyText}{</bodyText>}
  \msiclosetag{verbatim}{</verbatim>}}%

\begingroup
  \catcode`\<=\active
  \gdef<{\ifmmode\char`\<\else\char`\&lt;\fi}
\endgroup

\def\verb{%
   \msihmode
   \bgroup
      \catcode`\\=\other
      \catcode`{=\other
      \catcode`}=\other
      \catcode`&=\active
      \catcode`$=\other
      \catcode`##=\other
      \catcode`\<=\active
      \msiopentag{verb}{<verb>}%
      \@sverb
}

\def\verb@egroup{\msiclosetag{verb}{</verb>}\egroup}
\def\@sverb#1{%
  \catcode`#1\active
  \lccode`\~`#1\relax
  \lowercase{\let~\verb@egroup}%
}

%\def\fbox#1{\ifmmode\temptoksa={#1}\string\fbox\char`\{\the\temptoksa\char`\}\fi}

\MSIMathQuote{\fbox}

\def\{{\ifmmode\string\{\else\char123\relax\fi}
\def\}{\ifmmode\string\}\else\char125\relax\fi}

\let\@hbox\hbox
\def\hbox{%
   \def\@after{}
   \ifmmode
      \string\hbox\char`\{\aftergroup\endbrace
   \else
      \def\@after{\@hbox}%
   \fi
   \@after
}


\def\mathbf#1{\string\mathbf\char123#1\char125}
\def\mathfrak#1{\string\mathfrak\char123#1\char125}


\def\TeX{\msihmode\msitag{<texlogo xmlns="http://www.w3.org/1999/xhtml" name="tex">T<sub>E</sub>X</texlogo>}}
\def\LaTeX{\msihmode\msitag{<texlogo xmlns="http://www.w3.org/1999/xhtml" name="latex">L<sup>A</sup>T<sub>E</sub>X</texlogo>}}
\def\BibTeX{\msihmode\msitag{<texlogo xmlns="http://www.w3.org/1999/xhtml" name="bibtex">B<sup>i</sup>bT<sub>E</sub>X</texlogo>}}

% Operators


\def\TEXTsymbol#1{%
  \ifmmode
    \temptoksa={\TEXTsymbol{#1}}%
    \the\temptoksa
  \else
    $#1$%
  \fi
}

\msi@pass{\backslash}

\def\textemdash{\@hex{2014}}



{\catcode`\$=11\relax
 \gdef\${\char`\${}}
 \catcode`\_=11\relax
 \gdef\_{\char`\_{}}
 \catcode`\%=11\relax
 \gdef\%{\char`\%{}}
}




\def\@hex#1{\char38\char35x#1;}


\newif\if@inaccent
\@inaccentfalse


\def\@accent#1#2{%
    \if@inaccent
      \@@accent{#1}{#2}%
    \else
      \@inaccenttrue
      \expandafter\csname \@@accent{#1}{#2}\endcsname
      \@inaccentfalse
    \fi
}

\def\@@accent#1#2{%
    \ifx#1\i
      dotlessi-#2%
    \else\ifx#1\j
      dotlessj-#2%
    \else 
      #1-#2%
  \fi\fi\fi
}

\def\`#1{\@accent{#1}{grave}}

\def\'#1{\@accent{#1}{acute}}

\def\~#1{\@accent{#1}{tilde}}

\def\^#1{\@accent{#1}{caret}}

\def\=#1{\@accent{#1}{bar}}

\def\"#1{\@accent{#1}{umlat}}

\def\c#1{\@accent{#1}{ced}}

\def\.#1{\@accent{#1}{dot}}

\def\r#1{\@accent{#1}{r}}

\def\H#1{\@accent{#1}{H}}

\def\v#1{\@accent{#1}{v}}

\def\u#1{\@accent{#1}{u}}

\def\k#1{\@accent{#1}{k}}

\def\d#1{\@accent{#1}{d}}

\def\b#1{\@accent{#1}{b}}



\def\t#1{oo}

%% \'{\^{e}}

\def\MSIUnicode#1#2{\@namedef{#1}{\ifmmode\expandafter\string\csname#1\endcsname{}\else\@hex{#2}\fi}}


%% Spacing



\def\ {%
  \ifmmode
    \char`\\\char`\ %
  \else
    \msihmode\msitag{<hspace type="requiredSpace" dim="1em"/>}%
  \fi}

\def~{%
  \ifmmode
    \char`\~
  \else
    \msihmode\msitag{<hspace type="nonBreakingSpace">}\@hex{a0}\msitag{</hspace>}%
  \fi}

\def\/{%
  \ifmmode
    \char`\\\char`\/%
  \else
    \msihmode\msitag{<hspace dim="0.083en" type="italicCorrectionSpace">}\@hex{200a}\msitag{</hspace>}%
  \fi}






\bgroup
  \catcode`\%=12
  \gdef\strut{\msitag{<vspace lineHt="100%" type="strut"/>}}
\egroup


\def\noindent{\par\msitag{<hspace dim="0.0em" type="noIndent"></hspace>}}


\def\thinspace{%
   \ifmmode
      \string\thinspace
   \else
      \msihmode\msitag{<hspace dim="0.17em" type="thinSpace">}\@hex{2009}\msitag{</hspace>}%
   \fi
}

\def\thickspace{%
   \ifmmode
      \string\thickspace
   \else
      \msihmode\msitag{<hspace dim="0.5em" type="thickSpace">}\@hex{2002}\msitag{</hspace>}%
   \fi
}


\def\negthinspace{%
   \ifmmode
      \string\negthinspace
   \else
      \msihmode\msitag{<hspace dim="0.0em" type="negativeThinSpace"></hspace>}%
   \fi
}



\def\hrulefill{%
   <hspace fillWith="line" flex="1" class="stretchySpace" type="stretchySpace"></hspace>}



\def\newpage{\msitag{<msibreak type="newPage"><newPageRule/></msibreak>}}

\def\hfil{<hspace type="customSpace" class="stretchySpace"flex="1" atEnd="true"/>}
\def\hfill{<hspace type="customSpace" class="stretchySpace" flex="2" atEnd="true"/>}

%\msi@rfi{\msi@hook@hfil}{\hfil}
%\msi@rfi{\msi@hook@hfill}{\hfill}

%\msi@rfi{\msi@hook@vfil}{\vfil}
%\msi@rfi{\msi@hook@vfill}{\vfill}

\def\msi@hook@hss{\msitag{\hss}}
\def\msi@hook@vss{\msitag{\vss}}


\def\label#1{%
   \ifmmode
      \msitag{\label{#1}}%
   \else
      \msihmode\msitag{<marker id="#1"/>}%
   \fi}

\def\frac#1#2{\string\frac\@brace{#1}\@brace{#2}}
\def\dfrac#1#2{\string\dfrac\@brace{#1}\@brace{#2}}

\def\unit#1{\string\unit\@brace{#1}}

\def\mathbf#1{\string\mathbf\@brace{#1}}
\def\mathit#1{\string\mathit\@brace{#1}}
\def\mathsf#1{\string\mathsf\@brace{#1}}
\def\mathtt#1{\string\mathtt\@brace{#1}}
\def\mathrm#1{\string\mathrm\@brace{#1}}


\def\Big#1{\ifmmode\string\big#1\fi}
\def\big#1{\ifmmode\string\big#1\fi}
\def\Bigg#1{\ifmmode\string\big#1\fi}
\def\bigg#1{\ifmmode\string\big#1\fi}
\def\Bigl#1{\ifmmode\string\big#1\fi}
\def\bigl#1{\ifmmode\string\big#1\fi}
\def\Bigm#1{\ifmmode\string\big#1\fi}
\def\bigm#1{\ifmmode\string\big#1\fi}
\def\Bigr#1{\ifmmode\string\big#1\fi}
\def\bigr#1{\ifmmode\string\big#1\fi}
\def\Biggl#1{\ifmmode\string\big#1\fi}
\def\biggl#1{\ifmmode\string\big#1\fi}
\def\Biggm#1{\ifmmode\string\big#1\fi}
\def\biggm#1{\ifmmode\string\big#1\fi}
\def\Biggr#1{\ifmmode\string\big#1\fi}
\def\biggr#1{\ifmmode\string\big#1\fi}



\def\func#1{\string\func\@brace{#1}}
\def\limfunc#1{\string\limfunc\@brace{#1}}


\def\sqrt{%
  \@ifnextchar[%
    {\@nthroot}%
    {\@sqrt}}

\def\@sqrt#1{%
   \string\sqrt\@brace{#1}%
}

\def\@nthroot[#1]#2{%
   \string\sqrt[#1]\@brace{#2}%
}


%\msi@mathmlpass{\thinspace}



\def\mathpass@arg#1{%
  \def#1##1{\string#1\@brace{##1}}
}

\def\mathpass@arg@arg#1{%
  \def#1##1##2{\string#1\@brace{##1}\@brace{##2}}
}
\def\mathpass@arg@arg@arg#1{%
  \def#1##1##2##3{\string#1\@brace{##1}\@brace{##2}\@brace{##3}}
}
\def\mathpass@arg@arg@arg@arg#1{%
  \def#1##1##2##3##4{\string#1\@brace{##1}\@brace{##2}\@brace{##3}\@brace{##4}}
}

\def\mathpass@arg@arg@arg@arg@arg#1{%
  \def#1##1##2##3##4##5{\string#1\@brace{##1}\@brace{##2}\@brace{##3}\@brace{##4}\@brace{##5}}
}



\mathpass@arg{\tag}


\mathpass@arg{\mathbb}
\mathpass@arg{\mathcal}


\mathpass@arg@arg{\binom}
\mathpass@arg@arg{\dbinom}
\mathpass@arg@arg{\tbinom}

\mathpass@arg@arg{\QATOP}
\mathpass@arg@arg{\QTATOP}
\mathpass@arg@arg{\QDATOP}

\mathpass@arg@arg@arg{\QABOVE}
\mathpass@arg@arg@arg{\QTABOVE}
\mathpass@arg@arg@arg{\QDABOVE}
\mathpass@arg@arg@arg@arg{\QOVERD}
\mathpass@arg@arg@arg@arg{\QTOVERD}
\mathpass@arg@arg@arg@arg{\QDOVERD}
\mathpass@arg@arg@arg@arg{\QATOPD}
\mathpass@arg@arg@arg{\QTATOPD}
\mathpass@arg@arg@arg{\QDATOPD}

\def\unit#1{\string\unit\@brace{#1}}

\MSIMathQuote{\QABOVED} % special case? Why is this here?

\newif\if@mathintext
\@mathintextfalse 

{\catcode`\$=\active
 \gdef${%
   \if@mathintext
      \@mathintextfalse
      \msitag{\msipassthru}%
      \char`\{
      \msiopentag{mtext}{<mtext>}
   \else
      \@mathintexttrue
      \msiclosetag{mtext}{</mtext>}%
      \char`\}%
   \fi}
}


\def\text{\@mathintextfalse\catcode`\$=\active\@text}

\def\@text#1{%
  \begingroup
    \msitag{\msipassthru}%
    \char`\{%
    \msitag{<mspace width="thickmathspace"/>}%
    \msiopentag{mtext}{<mtext>}%
    \begingroup \msihmode #1\endgroup%
    \msiclosetag{mtext}{</mtext>}%
    \msitag{<mspace width="thickmathspace"/>}%
    \char`\}
    \catcode`\$=3\relax
  \endgroup}


\def\vspace{%
  \@ifnextchar*{\vspaceStar}{\vspaceB}}

\def\vspaceStar#1#2{%
  \@starredtrue
  \vspaceB{#2}}


\def\vspaceB#1{%
   \ifmmode
     \string\vspace\@brace{#1}%
   \else
     \msitag{<vspace dim="#1" type="customSpace"></vspace>}%
   \fi
}




\def\MSICounter#1{%
  \expandafter\newcount\csname c@#1\endcsname}

\def\&{\char`\&amp;}
\def\|{\Vert}



\def\out@hyperref#1#2#3#4{%
   \msiopentag{a}{<a href="#4">}#1\msiclosetag{a}{</a>}\ignorespaces}

\newif\if@in@texttag
\@in@texttagfalse

\def\QTP#1{%
  \par
  \msihmode
  \msiopentag{QTP}{<QTP type="#1">}%
  \begingroup
    \def\par{\msiclosetag{QTP}{</QTP>}\endgroup}%
}

\def\@ttclose#1{\msiclosetag{#1}{</#1>}}
\def\@closelasttexttag{\expandafter\@ttclose\expandafter{\@lasttexttag}}

\def\MSIFontSwitch{%
  \@ifnextchar[{\msi@font@switchA}{\msi@font@switchB}}


\def\msi@font@switchA[#1]#2{%
   \expandafter\def\csname#2\endcsname{%
      \ifmmode
        \expandafter\string\csname #2\endcsname\char`\  %
        %%\char`\\\msitag{#2}%
      \else
        \msihmode
        \if@in@texttag
           \expandafter\@ttclose\expandafter{\@lasttexttag}%
        \else
           \@in@texttagtrue
        \fi
        \gdef\@lasttexttag{#1}%
        \msiopentag{#1}{<#1>}%
        \aftergroup\@closelasttexttag
      \fi
   }
}

\def\msi@font@switchB#1{\msi@font@switchA[#1]{#1}}


\def\MSITextElement{%
  \@ifnextchar[{\msi@text@elmA}{\msi@text@elmB}}

\def\msi@text@elmA[#1]#2{%
  \expandafter\def\csname #2\endcsname##1{%
     \ifmmode
       \expandafter\string\csname #2\endcsname{##1}%
     \else
       \msihmode\msiopentag{#1}{<#1>}##1\msiclosetag{#1}{</#1>}%
     \fi}}

\def\msi@text@elmB#1{\msi@text@elmA[#1]{#1}}


\def\MSISimpleElement{%
  \@ifnextchar[{\msi@simple@elmA}{\msi@simple@elmB}}

\def\msi@simple@elmA[#1]#2{%
  \expandafter\def\csname #2\endcsname##1{%
     \ifmmode
       \expandafter\string\csname #2\endcsname{##1}%
     \else
       \msitag{^^0a}\msihmode\msiopentag{#1}{<#1>}##1\msiclosetag{#1}{</#1>}%
     \fi}}

\def\msi@simple@elmB#1{\msi@simple@elmA[#1]{#1}}






%% Create TeX Buttons

\def\MSITeXButton#1{%
    \expandafter\def\csname#1\endcsname{%
       \ifmmode
          \string\msipassthru\char`\{%}
       \else
          \msihmode 
       \fi
       \msitag{<texb enc="1" name="}#1\msitag{">}%
                <![CDATA[\expandafter\string\csname#1\endcsname]]>%
       \msitag{</texb>}%
       \ifmmode
         \char`\}%}
       \fi
     }}



\def\MSITeXButtonReq#1{%
    \expandafter\def\csname#1\endcsname##1{%
       \@temptokena={\msitag{##1}}%
       \ifmmode
         \string\msipassthru\char`\{%}%
       \else
         \msihmode
       \fi
       \msitag{<texb enc="1" name="}#1\msitag{">}%
           <![CDATA[\expandafter\string\csname#1\endcsname
           \ifmmode{\else\{\fi\the\@temptokena\ifmmode}\else\}\fi]]>%
       \msitag{</texb>}%
       \ifmmode
         \char`\}%}
       \fi}}

\def\MSITeXButtonReqReq#1{%
    \expandafter\def\csname#1\endcsname##1##2{%
       \@temptokena={\msitag{##1}}%
       \@temptokenb={\msitag{##2}}%
       \msihmode
       \msitag{<texb enc="1" name="#1">}%
          <![CDATA[\expandafter\string\csname#1\endcsname\{\the\@temptokena\}\{\the\@temptokenb\}]]>%
       \msitag{</texb>}}}


\def\fbox#1{\ifmmode
              \msitag{\msipassthru{<menclose notation='box'>}}%
              \msitag{\msipassthru}{\msihmode #1\par}%
              \msitag{\msipassthru{</menclose>}}%
            \else
              \msiopentag{fbox}{<smallbox>}#1\msiclosetag{fbox}{</smallbox>}%
            \fi}

\def\frame#1{\ifmmode
               \msitag{\frame{#1}}%
             \else
               \msiopentag{frame}{<frame>}#1\msiclosetag{frame}{</frame>}%
             \fi}



\def\TCItag{\@ifnextchar*{\@TCItagstar}{\@TCItag}}

\def\@TCItag#1{\msitag{\TCItag{#1}}}
\def\@TCItagstar*#1{\msitag{\TCItag{#1}}}

{\catcode`\'=\active
 \gdef'{^{\prime}}}


%\def\@TCItag#1{%
%    \global\tag@true
%    \global\def\@taggnum{(#1)}%
%    \global\def\@currentlabel{#1}}

%\def\@TCItagstar*#1{%
%    \global\tag@true
%    \global\def\@taggnum{#1}%
%    \global\def\@currentlabel{#1}}




\def\msi@cdr#1#2xxxx{#2}

\def\MSILocalDef#1{\def#1{\string #1}}



\bgroup
     \@make@braces@other
     \catcode `|=0
     \catcode`\(=1  % use parens for braces
     \catcode`\)=2
     \catcode`\\=12
     |gdef|MSITeXButtonEnvironment#1(%
          |expandafter|gdef|csname msi@begin@#1|endcsname
             (|bgroup
                 |@make@braces@other
                 |catcode`|\=12
                 |catcode`|&=12
                 |aftergroup|@make@braces@normal
                 |csname scan@#1|endcsname)

          |expandafter|gdef|csname scan@#1|endcsname##1\end{#1}%
             (|msitag(<texb enc="1" name="#1">%
                        <![CDATA[\begin{#1}##1\end{#1}]]>%
                      </texb>)%
              |egroup)
     )%
|egroup



%% Various note type things

\def\@start@notewrapper{%
    \msiopentag{notewrapper}{<notewrapper xmlns="http://www.w3.org/1999/xhtml">}}

\def\@end@notewrapper{%
    \msiclosetag{notewrapper}{</notewrapper>}}

\def\@end@footnote{\msiclosetag{note}{</note>}\@end@notewrapper}
\def\@innote{\bgroup\aftergroup\@end@footnote}

%%<note type="#2">


\def\footnote{%
    \br\@start@notewrapper
    \msiopentag{note}{<note type="footnote">}%
    \msiopentag{bodyText}{<bodyText>}%
    % Next couple lines read the brace following \footnote and then does \footnoteb
    \afterassignment\@footnoteb
    \let\junk
}
\def\@footnoteb{%
    \bgroup
    \def\par{\msiclosetag{bodyText}{</bodyText>}\msiopentag{bodyText}{<bodyText>}}
    \aftergroup\@footnotec
}

\def\@footnotec{
    \msiclosetag{bodyText}{</bodyText>}%
    \msiclosetag{note}{</note>}%
    \@end@notewrapper}

\def\out@CustomNoteA[#1]#2#3{%
    \msiopentag{notewrapper}{<notewrapper xmlns="http://www.w3.org/1999/xhtml">}%
    \msiopentag{note}{<note type="#2">}%
    \bgroup
      \@in@texttagfalse% turn this off so we don't close pending tags if we nest a font switch. 
      #3%
    \egroup
    \msiclosetag{note}{</note>}%
    \msiclosetag{notewrapper}{</notewrapper>}%
}

\def\out@CustomNoteB#1#2{%
    \msiopentag{notewrapper}{<notewrapper xmlns="http://www.w3.org/1999/xhtml">}%
    \msiopentag{note}{<note type="#1">}%
    \bgroup
      \@in@texttagfalse% turn this off so we don't close pending tags if we nest a font switch. 
      #2%
    \egroup
    \msiclosetag{note}{</note>}%
    \msiclosetag{notewrapper}{</notewrapper>}%
}


%\MSIMathQuote{\\} %% may need to hard-code this one:

\def\\{\@ifnextchar[{\@linebrk}{\@linebrk[0pt]}}


\def\@linebrk[#1]{\ifmmode\string\\\else\msitag{<br/>}\fi}

%% Temporary until prince can read xml

\newtoks\msi@extrapi

\def\msi@opendocument{%
   \msitag{<?xml version="1.0" encoding="UTF-8"?>}\br
   \msitag{<?xml-stylesheet href="css/my.css" type="text/css"?>}\br
   \msitag{<?sw-tagdefs href="resource://app/res/tagdefs/latexdefs.xml" type="text/xml" ?>}\br
   \the\msi@extrapi
   \msitag{<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd">}\br

   \msitag{<html xmlns="http://www.w3.org/1999/xhtml" 
             xmlns:mml="http://www.w3.org/1998/Math/MathML"
             xmlns:sw="http://www.sciword.com/namespaces/sciword">}

   \br\msitag{<head>}
   \br\msiopentag{preamble}{<preamble>}
   \msi@inpreamble=1

   \def\makeatother{%
       \msihmode
       \msitag{<texb enc="1" name="makeatother">}%
           <![CDATA[\string\makeatother]]>%
       \msitag{</texb>}%
       \catcode`\@=12}

   \def\makeatletter{%
       \msihmode
       \msitag{<texb enc="1" name="makeatletter">}%
           <![CDATA[\string\makeatletter]]>%
       \msitag{</texb>}%
       \catcode`\@=11}

}


\def\@gobbleit{\let\@temptok}

\futurelet\@bracetok\@gobbleit{
\futurelet\@brackettok\@gobbleit[
\futurelet\@startok\@gobbleit*

\begingroup
  \@make@braces@other
  \catcode`\[=1
  \catcode`\]=2
  \gdef\msi@lbrace[{]
  \gdef\msi@rbrace[}]
\endgroup

\def\@inbrace#1{%
   \ifnum\msi@inpreamble=1
     \expandafter\msitopreambleextra\expandafter{\msi@lbrace}%
     \msitopreambleextra{#1}%
     \expandafter\msitopreambleextra\expandafter{\msi@rbrace}%
   \else
     \@temptokena={\msitag{#1}}%
     \{\the\@temptokena\}
   \fi
   \@gobbleargs}

\def\@inbracket[#1]{%
   \ifnum\msi@inpreamble=1
     \msitopreambleextra{[#1]}%
   \else
     \@temptokena={\msitag{[#1]}}%
     \the\@temptokena
   \fi
   \@gobbleargs}

\def\@astar*{*\@gobbleargs}

\def\@gobbleargs{\futurelet\atok\@gobblemore}

\def\@endgobble{\@endtexb\relax}

\def\@gobblemore{%
   \ifx\atok\@bracetok
     \let\@donext\@inbrace
   \else
     \ifx\atok\@brackettok
       \let\@donext\@inbracket
     \else
       \ifx\atok\@startok
         \let\@donext\@astar
       \else
         \let\@donext\@endgobble
       \fi
     \fi
   \fi
   \@donext}



% Here #1 = some unknown control sequence 

\def\msidefault#1{%
  \ifmmode
    %\string#1%
    \msitag{\msipassthru}%
    \char`\{
    \msiopentag{texb}{<texb enc="1" name="#1">}%
       \msitag{<![CDATA[#1}
    %\def\@next{\relax}%
    \let\@next\@gobbleargs
  \else
    \def\@next{\expandafter\msidefaulta\expandafter{\string #1}}%
  \fi
  \@next}

\def\msidefaulta#1{%
  \expandafter\msidefaultb\expandafter{\msi@cdr#1xxxx}}


\def\msidefaultb#1{%
    \msihmode
    \ifnum\msi@inpreamble=1
      \temptoksa={<texb enc="1" name="#1">}%
      \expandafter\msitopreambleextra\expandafter{\the\temptoksa}
      \msiopentag{texb}{}%
      \msitopreambleextra{<![CDATA[}
      \expandafter\temptoksa\expandafter{\csname#1\endcsname}
      \expandafter\msitopreambleextra\expandafter{\the\temptoksa}
    \else
      \msiopentag{texb}{<texb enc="1" name="#1">}%
         \msitag{<![CDATA[}\expandafter\string\csname#1\endcsname
    \fi
    \@gobbleargs}

\def\@endtexb{% 
    \ifnum\msi@inpreamble=1
       \msitopreambleextra{]]></texb>}
       \msiclosetag{texb}{}
    \else
         \msitag{]]>}%
         \msiclosetag{texb}{</texb>}%
         \ifmmode
           \char`\} % to close off msipassthru
         \fi
    \fi}


\def\msi@begin@figure{%
  \@ifnextchar[{\msi@begin@figureA}{msi@begin@figureB}}


\def\msi@begin@figureA[#1]{%
   \msiopentag{msiframe}{<msiframe opt="#1">}%
}

\def\msi@begin@figureB{%
   \msiopentag{msiframe}{<msiframe>}%
}

\def\msi@end@figure{%
   \msiclosetag{msiframe}{</msiframe>}%
}



\def\msi@begin@table{%
  \@ifnextchar[{\msi@begin@tableA}{msi@begin@tableB}}


\def\msi@begin@tableA[#1]{%
   \msiopentag{msiframe}{<msiframe kind="table" opt="#1">}%
}

\def\msi@begin@tableB{%
   \msiopentag{msiframe}{<msiframe kind="table">}%
}

\def\msi@end@table{%
   \msiclosetag{msiframe}{</msiframe>}%
}


\def\caption{\msi@caption}

\def\msi@caption#1{%
  \msiopentag{caption}{<caption align="bottom">}%
  \msiopentag{bodyText}{<bodyText>}
  #1%
  \msiclosetag{bodyText}{</bodyText>}
  \msiclosetag{caption}{</caption>}%
}

\def\msi@begin@filecontents#1\end%
{
   \expandafter\preambleToks\expandafter{\the\preambleToks^^0a\string\begin{filecontents}#1\string\end}%
}


% A hack to fool the jbm filter into handling \dots gracefully
%\def\dots{%
%  \ifmmode
%    \msitag{\U{2026}}%
%  \else
%    }

\input latex-default.tex
%\input tcilatex.tex

\catcode`\<=\active
